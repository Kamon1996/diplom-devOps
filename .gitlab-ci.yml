stages:
  - lint
  - test
  - build
  - deploy
  - notify

variables:
  APP_IMAGE: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA
  APP_IMAGE_LATEST: $CI_REGISTRY_IMAGE:latest

# ============================================
# LINT — golangci-lint
# ============================================
lint:
  stage: lint
  image: golangci/golangci-lint:v1.64-alpine
  script:
    - cd habits-tracker
    - golangci-lint run ./...
  allow_failure: false

# ============================================
# TEST — go test + PostgreSQL service
# ============================================
test:
  stage: test
  image: golang:1.26-alpine
  services:
    - name: postgres:15-alpine
      alias: postgres
  variables:
    POSTGRES_DB: habit_test
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
    DATABASE_URL: "postgres://postgres:postgres@postgres:5432/habit_test?sslmode=disable"
  script:
    - cd habits-tracker
    - go test -v -coverprofile=coverage.out ./...
    - go tool cover -func=coverage.out
  coverage: '/total:\s+\(statements\)\s+(\d+\.\d+)%/'
  artifacts:
    paths:
      - habits-tracker/coverage.out
    expire_in: 7 days

# ============================================
# BUILD — Docker build + push to GitLab Registry
# ============================================
build:
  stage: build
  image: docker:27
  services:
    - docker:27-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $APP_IMAGE -t $APP_IMAGE_LATEST .
    - docker push $APP_IMAGE
    - docker push $APP_IMAGE_LATEST
  after_script:
    - docker logout $CI_REGISTRY

# ============================================
# DEPLOY — SSH to app-server (only master/main)
# ============================================
deploy:
  stage: deploy
  image: alpine:3.21
  only:
    - master
    - main
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - chmod 400 "$SSH_PRIVATE_KEY"
    - ssh-add "$SSH_PRIVATE_KEY"
    - mkdir -p ~/.ssh
    - ssh-keyscan -H $APP_SERVER_IP >> ~/.ssh/known_hosts
  script:
    - |
      ssh -o StrictHostKeyChecking=no ubuntu@$APP_SERVER_IP << 'DEPLOY_SCRIPT'
        cd /opt/habits-tracker

        # Update image tag in .env
        sed -i "s|^APP_IMAGE=.*|APP_IMAGE=${APP_IMAGE}|" .env

        # Login to GitLab Container Registry
        echo "${CI_REGISTRY_PASSWORD}" | docker login -u "${CI_REGISTRY_USER}" --password-stdin ${CI_REGISTRY}

        # Pull and restart
        docker compose pull
        docker compose up -d --remove-orphans

        # Wait for health check
        for i in $(seq 1 12); do
          if curl -sf http://localhost/nginx-health > /dev/null 2>&1; then
            echo "Health check passed"
            exit 0
          fi
          echo "Waiting for app to start... ($i/12)"
          sleep 5
        done
        echo "Health check failed after 60s"
        exit 1
      DEPLOY_SCRIPT
  environment:
    name: production
    url: http://$APP_SERVER_IP

# ============================================
# NOTIFY — Telegram (always runs)
# ============================================
notify_success:
  stage: notify
  image: alpine:3.21
  when: on_success
  script:
    - apk add --no-cache curl
    - |
      curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
        -d chat_id="${TELEGRAM_CHAT_ID}" \
        -d parse_mode="HTML" \
        -d text="✅ <b>Pipeline #${CI_PIPELINE_ID} SUCCESS</b>
      Project: ${CI_PROJECT_NAME}
      Branch: ${CI_COMMIT_REF_NAME}
      Commit: <code>${CI_COMMIT_SHORT_SHA}</code> — ${CI_COMMIT_TITLE}
      <a href=\"${CI_PIPELINE_URL}\">Open pipeline</a>"

notify_failure:
  stage: notify
  image: alpine:3.21
  when: on_failure
  script:
    - apk add --no-cache curl
    - |
      curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
        -d chat_id="${TELEGRAM_CHAT_ID}" \
        -d parse_mode="HTML" \
        -d text="❌ <b>Pipeline #${CI_PIPELINE_ID} FAILED</b>
      Project: ${CI_PROJECT_NAME}
      Branch: ${CI_COMMIT_REF_NAME}
      Commit: <code>${CI_COMMIT_SHORT_SHA}</code> — ${CI_COMMIT_TITLE}
      <a href=\"${CI_PIPELINE_URL}\">Open pipeline</a>"
