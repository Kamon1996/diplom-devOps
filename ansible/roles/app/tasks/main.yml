---
- name: Create deploy directory
  file:
    path: "{{ deploy_dir }}"
    state: directory
    owner: ubuntu
    group: ubuntu
    mode: "0755"

- name: Create nginx config directory
  file:
    path: "{{ deploy_dir }}/nginx"
    state: directory
    owner: ubuntu
    group: ubuntu
    mode: "0755"

- name: Copy docker-compose.yml
  copy:
    src: ../../../../docker/app/docker-compose.yml
    dest: "{{ deploy_dir }}/docker-compose.yml"
    owner: ubuntu
    group: ubuntu
    mode: "0644"
  notify: restart app

- name: Copy nginx.conf
  copy:
    src: ../../../../docker/app/nginx/nginx.conf
    dest: "{{ deploy_dir }}/nginx/nginx.conf"
    owner: ubuntu
    group: ubuntu
    mode: "0644"
  notify: restart app

- name: Copy init.sql
  copy:
    src: ../../../../habits-tracker/init.sql
    dest: "{{ deploy_dir }}/init.sql"
    owner: ubuntu
    group: ubuntu
    mode: "0644"

- name: Generate .env from vault secrets
  template:
    src: env.j2
    dest: "{{ deploy_dir }}/.env"
    owner: ubuntu
    group: ubuntu
    mode: "0600"
  notify: restart app

- name: Pull Docker images
  command: docker compose pull
  args:
    chdir: "{{ deploy_dir }}"
  become: false
  changed_when: true

- name: Start application stack
  command: docker compose up -d --remove-orphans
  args:
    chdir: "{{ deploy_dir }}"
  become: false
  changed_when: true

- name: Wait for app to become healthy
  uri:
    url: "http://localhost/nginx-health"
    status_code: 200
  register: health_check
  retries: 10
  delay: 5
  until: health_check.status == 200
